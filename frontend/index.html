<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Credential NFT - Gig Worker Lending Pool</title>
    <script src="./lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }
        
        .nft-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .nft-card:hover {
            border-color: #4facfe;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.15);
        }
        
        .nft-info {
            margin-bottom: 15px;
        }
        
        .nft-info strong {
            color: #2c3e50;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .wallet-info {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #4facfe;
        }
        
        .rating {
            color: #ffc107;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Professional Credential NFT</h1>
            <p>AI-Driven NFT-backed Micro-Lending Pool for Gig Workers</p>
        </div>
        
        <div class="main-content">
            <div class="wallet-info">
                <h3>Wallet Connection Status</h3>
                <p id="walletStatus">Not connected</p>
                <p id="contractStatus">Contract not loaded</p>
            </div>
            
            <button class="btn" onclick="connectWallet()">Connect Wallet</button>
            <button class="btn" onclick="loadContract()">Load Contract</button>
            
            <div class="grid">
                
                <div class="card">
                    <h2>Whitelist Client</h2>
                    <div class="form-group">
                        <label for="clientAddress">Client Address:</label>
                        <input type="text" id="clientAddress" placeholder="0x...">
                    </div>
                    <button class="btn" onclick="whitelistClient()">Whitelist Client</button>
                    <div id="whitelistStatus"></div>
                </div>
                
                <div class="card">
                    <h2>Mint Credential NFT</h2>
                    <div class="form-group">
                        <label for="gigWorkerAddress">Gig Worker Address:</label>
                        <input type="text" id="gigWorkerAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label for="projectName">Project Name:</label>
                        <input type="text" id="projectName" placeholder="Logo Design for Acme Corp">
                    </div>
                    <div class="form-group">
                        <label for="projectDescription">Project Description:</label>
                        <textarea id="projectDescription" placeholder="Credential NFT for completed project..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="projectDetails">Project Details:</label>
                        <input type="text" id="projectDetails" placeholder="Logo design, branding, and delivery...">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount:</label>
                        <input type="text" id="paymentAmount" placeholder="500 USDC">
                    </div>
                    <div class="form-group">
                        <label for="clientRating">Client Rating (1-5):</label>
                        <select id="clientRating">
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Very Good</option>
                            <option value="3">3 - Good</option>
                            <option value="2">2 - Fair</option>
                            <option value="1">1 - Poor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientName">Client Name:</label>
                        <input type="text" id="clientName" placeholder="Acme Corp">
                    </div>
                    <button class="btn" onclick="mintCredential()">Mint Credential</button>
                    <div id="mintStatus"></div>
                </div>
                
                <div class="card">
                    <h2>View NFT Details</h2>
                    <div class="form-group">
                        <label for="tokenId">Token ID:</label>
                        <input type="number" id="tokenId" placeholder="0">
                    </div>
                    <button class="btn" onclick="viewNFT()">View NFT</button>
                    <div id="nftDetails"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>Minted NFTs</h2>
                <button class="btn" onclick="loadAllNFTs()">Load All NFTs</button>
                <div id="nftList"></div>
            </div>
        </div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // Pre-fill with deployed contract address
        
        const contractABI = [
            "constructor()",
            "function nextTokenId() view returns (uint256)",
            "function whitelistedClients(address) view returns (bool)",
            "function setWhitelistedClient(address client, bool status)",
            "function mintCredential(address to, string memory tokenURI) returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function balanceOf(address owner) view returns (uint256)",
            "event CredentialMinted(address indexed to, uint256 indexed tokenId, string tokenURI)",
            "event ClientWhitelisted(address indexed client, bool status)"
        ];
        
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    const address = await signer.getAddress();
                    document.getElementById('walletStatus').innerHTML = `Connected: ${address.substring(0, 6)}...${address.substring(38)}`;
                    showStatus('walletStatus', 'Wallet connected successfully!', 'success');
                } catch (error) {
                    showStatus('walletStatus', 'Failed to connect wallet: ' + error.message, 'error');
                }
            } else {
                showStatus('walletStatus', 'Please install MetaMask!', 'error');
            }
        }
        
        async function loadContract() {
            if (!signer) {
                showStatus('contractStatus', 'Please connect wallet first!', 'error');
                return;
            }
            
            try {
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                document.getElementById('contractStatus').innerHTML = `Contract loaded: ${contractAddress.substring(0, 6)}...${contractAddress.substring(38)}`;
                showStatus('contractStatus', 'Contract loaded successfully!', 'success');
            } catch (error) {
                showStatus('contractStatus', 'Failed to load contract: ' + error.message, 'error');
            }
        }
        
        async function whitelistClient() {
            if (!contract) {
                showStatus('whitelistStatus', 'Please load contract first!', 'error');
                return;
            }
            
            const clientAddress = document.getElementById('clientAddress').value;
            if (!clientAddress) {
                showStatus('whitelistStatus', 'Please enter client address!', 'error');
                return;
            }
            
            try {
                showStatus('whitelistStatus', 'Whitelisting client...', 'info');
                const tx = await contract.setWhitelistedClient(clientAddress, true);
                await tx.wait();
                showStatus('whitelistStatus', `Client ${clientAddress} whitelisted successfully!`, 'success');
            } catch (error) {
                showStatus('whitelistStatus', 'Failed to whitelist client: ' + error.message, 'error');
            }
        }
        
        async function mintCredential() {
            if (!contract) {
                showStatus('mintStatus', 'Please load contract first!', 'error');
                return;
            }
            
            const gigWorkerAddress = document.getElementById('gigWorkerAddress').value;
            const projectName = document.getElementById('projectName').value;
            const projectDescription = document.getElementById('projectDescription').value;
            const projectDetails = document.getElementById('projectDetails').value;
            const paymentAmount = document.getElementById('paymentAmount').value;
            const clientRating = document.getElementById('clientRating').value;
            const clientName = document.getElementById('clientName').value;
            
            if (!gigWorkerAddress || !projectName) {
                showStatus('mintStatus', 'Please fill in required fields!', 'error');
                return;
            }
            
            try {
                showStatus('mintStatus', 'Creating metadata and minting NFT...', 'info');
                
                // Create metadata
                const metadata = {
                    name: projectName,
                    description: projectDescription || `Credential NFT for completed project: ${projectName}`,
                    project_details: projectDetails || "Project completed successfully",
                    completion_date: new Date().toISOString().split('T')[0],
                    payment_amount: paymentAmount || "Not specified",
                    client_rating: parseInt(clientRating),
                    client: clientName || "Anonymous Client",
                    freelancer: gigWorkerAddress
                };
                
                // For demo purposes, we'll use a data URI instead of IPFS
                const metadataURI = `data:application/json;base64,${btoa(JSON.stringify(metadata))}`;
                
                const tx = await contract.mintCredential(gigWorkerAddress, metadataURI);
                const receipt = await tx.wait();
                
                // Find the minted token ID from events
                const event = receipt.events.find(e => e.event === 'CredentialMinted');
                const tokenId = event ? event.args.tokenId.toString() : 'Unknown';
                
                showStatus('mintStatus', `NFT minted successfully! Token ID: ${tokenId}`, 'success');
                
                // Clear form
                document.getElementById('gigWorkerAddress').value = '';
                document.getElementById('projectName').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('projectDetails').value = '';
                document.getElementById('paymentAmount').value = '';
                document.getElementById('clientName').value = '';
                
            } catch (error) {
                showStatus('mintStatus', 'Failed to mint NFT: ' + error.message, 'error');
            }
        }
        
        async function viewNFT() {
            if (!contract) {
                showStatus('nftDetails', 'Please load contract first!', 'error');
                return;
            }
            
            const tokenId = document.getElementById('tokenId').value;
            if (tokenId === '') {
                showStatus('nftDetails', 'Please enter token ID!', 'error');
                return;
            }
            
            try {
                const tokenURI = await contract.tokenURI(tokenId);
                const owner = await contract.ownerOf(tokenId);
                
                let metadataHTML = `
                    <div class="nft-card">
                        <div class="nft-info"><strong>Token ID:</strong> ${tokenId}</div>
                        <div class="nft-info"><strong>Owner:</strong> ${owner}</div>
                        <div class="nft-info"><strong>Token URI:</strong> ${tokenURI.substring(0, 50)}...</div>
                `;
                
                // Try to parse metadata if it's a data URI
                if (tokenURI.startsWith('data:application/json;base64,')) {
                    try {
                        const base64Data = tokenURI.split(',')[1];
                        const metadata = JSON.parse(atob(base64Data));
                        
                        metadataHTML += `
                            <div class="nft-info"><strong>Project:</strong> ${metadata.name}</div>
                            <div class="nft-info"><strong>Description:</strong> ${metadata.description}</div>
                            <div class="nft-info"><strong>Client:</strong> ${metadata.client}</div>
                            <div class="nft-info"><strong>Payment:</strong> ${metadata.payment_amount}</div>
                            <div class="nft-info"><strong>Rating:</strong> <span class="rating">${'★'.repeat(metadata.client_rating)}</span></div>
                            <div class="nft-info"><strong>Completion Date:</strong> ${metadata.completion_date}</div>
                        `;
                    } catch (e) {
                        console.log('Could not parse metadata:', e);
                    }
                }
                
                metadataHTML += '</div>';
                document.getElementById('nftDetails').innerHTML = metadataHTML;
                
            } catch (error) {
                showStatus('nftDetails', 'Failed to load NFT: ' + error.message, 'error');
            }
        }
        
        async function loadAllNFTs() {
            if (!contract) {
                showStatus('nftList', 'Please load contract first!', 'error');
                return;
            }
            
            try {
                showStatus('nftList', 'Loading all NFTs...', 'info');
                
                const nextTokenId = await contract.nextTokenId();
                const totalNFTs = nextTokenId.toNumber();
                
                if (totalNFTs === 0) {
                    document.getElementById('nftList').innerHTML = '<p>No NFTs minted yet.</p>';
                    return;
                }
                
                let nftListHTML = '<div class="grid">';
                
                for (let i = 0; i < totalNFTs; i++) {
                    try {
                        const owner = await contract.ownerOf(i);
                        const tokenURI = await contract.tokenURI(i);
                        
                        nftListHTML += `
                            <div class="nft-card">
                                <div class="nft-info"><strong>Token ID:</strong> ${i}</div>
                                <div class="nft-info"><strong>Owner:</strong> ${owner.substring(0, 6)}...${owner.substring(38)}</div>
                        `;
                        
                        // Try to parse metadata if it's a data URI
                        if (tokenURI.startsWith('data:application/json;base64,')) {
                            try {
                                const base64Data = tokenURI.split(',')[1];
                                const metadata = JSON.parse(atob(base64Data));
                                
                                nftListHTML += `
                                    <div class="nft-info"><strong>Project:</strong> ${metadata.name}</div>
                                    <div class="nft-info"><strong>Client:</strong> ${metadata.client}</div>
                                    <div class="nft-info"><strong>Payment:</strong> ${metadata.payment_amount}</div>
                                    <div class="nft-info"><strong>Rating:</strong> <span class="rating">${'★'.repeat(metadata.client_rating)}</span></div>
                                `;
                            } catch (e) {
                                nftListHTML += `<div class="nft-info"><strong>Metadata:</strong> Could not parse</div>`;
                            }
                        }
                        
                        nftListHTML += '</div>';
                        
                    } catch (error) {
                        console.log(`Error loading NFT ${i}:`, error);
                    }
                }
                
                nftListHTML += '</div>';
                document.getElementById('nftList').innerHTML = nftListHTML;
                
            } catch (error) {
                showStatus('nftList', 'Failed to load NFTs: ' + error.message, 'error');
            }
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }
        
        // Auto-connect wallet on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.log('Auto-connect failed:', error);
                }
            }
        });
    </script>
</body>
</html>